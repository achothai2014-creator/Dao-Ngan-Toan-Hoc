<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ l√Ω To√°n h·ªçc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- KaTeX CSS (S·ª≠a l·ªói: 'integrity' thay v√¨ 'xintegrity') -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" 
          xintegrity="sha384-KiWOvVjnN8qwZuNkfzOEE5jscrJ52i4MGpnIfNLMnL0iXgHIXdN4pk1H0OmdtLoV" 
          crossorigin="anonymous">
    
    <!-- KaTeX JS (S·ª≠a l·ªói: 'integrity' v√† th√™m 'defer') -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" 
            xintegrity="sha384-hIoBPJpTadxVFVvJscMuNmrjJ2LbxD5PSoROSxETlRkLhSROkfB9I/2+QigM2bgo" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" 
            xintegrity="sha384-gE/VvHhSSSMyLBCKTUvMcV0pMhLG+A1xLhYQDN7x/zIinaY/KqMvATq1TqgJ2+no" 
            crossorigin="anonymous"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* TƒÉng c∆∞·ªùng ƒë·ªãnh d·∫°ng cho n·ªôi dung tr·∫£ v·ªÅ */
        .response-content h1,
        .response-content h2,
        .response-content h3,
        .response-content h4 {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .response-content h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .response-content h2 {
            font-size: 1.5rem;
        }

        .response-content h3 {
            font-size: 1.25rem;
        }

        .response-content h4 {
            font-size: 1.125rem;
        }

        .response-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .response-content ul,
        .response-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            list-style-position: outside;
        }

        .response-content ul {
            list-style-type: disc;
        }

        .response-content ol {
            list-style-type: decimal;
        }
        
        .response-content li {
            margin-bottom: 0.5rem;
        }

        .response-content strong {
            font-weight: 600;
        }

        .response-content em {
            font-style: italic;
        }

        /* ƒê·ªãnh d·∫°ng b·∫£ng (table) */
        .response-content table {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
            border: 1px solid #ddd;
        }

        .response-content th,
        .response-content td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .response-content th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        .response-content tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* ƒê·∫£m b·∫£o KaTeX hi·ªÉn th·ªã ƒë√∫ng */
        .katex-display {
            display: block;
            margin: 1em 0;
            text-align: center;
            overflow-x: auto;
            overflow-y: hidden;
        }
    </style>
</head>

<!-- S·ª≠a l·ªói giao di·ªán: X√≥a 'h-full' v√† 'items-center' ƒë·ªÉ n·ªôi dung neo l√™n tr√™n v√† cho ph√©p cu·ªôn -->
<body class="bg-gray-50 min-h-screen font-inter">

    <div class="w-full max-w-3xl mx-auto p-4 md:p-8">
        
        <!-- Ti√™u ƒë·ªÅ ch√≠nh -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 flex items-center justify-center gap-3">
                Tr·ª£ l√Ω To√°n h·ªçc
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="#FB923C" d="M19 3H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 7h2v2H9zM7 11h2v2H7zM5 15h2v2H5zM5 11h2v2H5zM5 7h2v2H5zm6 8H9v-2h2zm0-4H9v-2h2zm0-4H9V7h2zm6 8h-2v-2h2zm0-4h-2v-2h2zm0-4h-2V7h2zm-4 8h-2v-2h2zm0-4h-2v-2h2zM5 19v-2h2v2zM9 19v-2h2v2zM13 19v-2h2v2zm4 0v-2h2v2z"/></svg>
            </h1>
            <p class="text-gray-600 mt-2">Gi·∫£i b√†i t·∫≠p ƒê·∫°i s·ªë & H√¨nh h·ªçc (l·ªõp 6-12), k√®m theo m·∫πo v√† t·ªïng k·∫øt c√¥ng th·ª©c.</p>
        </header>

        <!-- Khu v·ª±c nh·∫≠p li·ªáu -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m19.1 4.9c-1.2-1.2-3.1-1.2-4.2 0L13.8 6c.6.6.9 1.3.9 2.2c0 .4-.1.7-.2 1.1l2.8 2.8c.4-.1.7-.2 1.1-.2c.9 0 1.6.3 2.2.9l1.1-1.1c1.2-1.2 1.2-3.1 0-4.2M5.1 19.3l-1.4 1.4c-1.2 1.2-1.2 3.1 0 4.2c1.2 1.2 3.1 1.2 4.2 0L9 23.8c-.6-.6-.9-1.3-.9-2.2c0-.4.1-.7.2-1.1L5.5 17.7c-.4.1-.7.2-1.1.2c-.9 0-1.6-.3-2.2-.9m11.1-2.9l-2.8-2.8c.4-.1.7-.2 1.1-.2c.9 0 1.6.3 2.2.9l1.1-1.1c1.2-1.2 1.2-3.1 0-4.2s-3.1-1.2-4.2 0L13.2 9c-.6.6-.9 1.3-.9 2.2c0 .4.1.7.2 1.1l-2.8 2.8c-.4-.1-.7-.2-1.1-.2c-.9 0-1.6.3-2.2.9L5.3 18c-1.2-1.2-3.1-1.2-4.2 0s-1.2 3.1 0 4.2l1.1 1.1c.6.6 1.3.9 2.2.9c.4 0 .7-.1 1.1-.2l2.8-2.8c.1.4.2.7.2 1.1c0 .9.3 1.6.9 2.2l1.1 1.1c1.2 1.2 3.1 1.2 4.2 0s1.2-3.1 0-4.2l-1.1-1.1c-.6-.6-1.3-.9-2.2-.9c-.4 0-.7.1-1.1.2l2.8-2.8c.1.4.2.7.2 1.1c0 .9.3 1.6.9 2.2l1.1 1.1c1.2 1.2 3.1 1.2 4.2 0c1.2-1.2 1.2-3.1 0-4.2z"/></svg>
                Nh·∫≠p ƒë·ªÅ b√†i c·ªßa b·∫°n
            </h2>
            <textarea id="prompt-input"
                class="w-full h-32 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="V√≠ d·ª•: Gi·∫£i ph∆∞∆°ng tr√¨nh b·∫≠c 2: x^2 - 3x + 2 = 0"></textarea>

            <!-- T·∫£i ·∫£nh l√™n -->
            <div class="mt-4 flex items-center gap-3">
                <label
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md cursor-pointer text-sm">
                    <span>T·∫£i ·∫£nh ƒë·ªÅ b√†i (n·∫øu c√≥)</span>
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                </label>
                <span id="file-name" class="text-sm text-gray-500"></span>
            </div>

            <!-- N√∫t Gi·∫£i b√†i -->
            <button id="solve-button"
                class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                Gi·∫£i b√†i
            </button>
        </div>

        <!-- ƒê∆∞·ªùng k·∫ª ph√¢n c√°ch -->
        <hr class="my-8 border-gray-200">

        <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ -->
        <div id="result-container" class="bg-white p-6 rounded-lg shadow-md min-h-[10rem]">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2M9 17H7v-2h2zm4 0h-2v-2h2zm4 0h-2v-2h2zM9 13H7V7h2zm4 0h-2V7h2zm4 0h-2V7h2z"/></svg>
                B√†i gi·∫£i:
            </h2>

            <!-- Hi·ªÉn th·ªã Loading -->
            <div id="loading-indicator" class="text-center text-gray-500 hidden">
                <svg class="animate-spin h-6 w-6 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="mt-2">AI ƒëang suy nghƒ©...</p>
            </div>

            <!-- Hi·ªÉn th·ªã L·ªói -->
            <div id="error-message" class="text-red-600 hidden"></div>
            
            <!-- Hi·ªÉn th·ªã K·∫øt qu·∫£ -->
            <div id="result-text" class="response-content"></div>

            <!-- Hi·ªÉn th·ªã Ngu·ªìn tham kh·∫£o -->
            <div id="sources-container" class="mt-6 hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="m13.09 20.29l-1.42 1.42L5.5 15.54V5.5h10.04l-3.47 3.47l1.42 1.42l3.47-3.47V15.5c0 1.25-.48 2.42-1.34 3.3l-2.5 2.49m5.56-8.94L17.24 10l1.42-1.42l-1.42-1.42l1.42-1.42l-1.42-1.42l1.42-1.42L17.24 1.5l-1.42 1.42l-1.41-1.42l-1.42 1.42L11.58 1.5l-1.41 1.42L8.76 1.5L7.34 2.92L5.92 1.5L4.5 2.92L3.09 1.5L1.67 2.92L3.09 4.34L1.67 5.76l1.42 1.42l-1.42 1.41l1.42 1.42l-1.42 1.41l1.42 1.42l1.41-1.42l1.42 1.42l1.41-1.42l1.42 1.42l2.83-2.83l1.41 1.42z"/></svg>
                    Ngu·ªìn tham kh·∫£o:
                </h3>
                <ul id="sources-list" class="list-disc list-inside text-sm text-blue-600 space-y-1">
                </ul>
            </div>
        </div>
    </div>

    <script type"module">
        const promptInput = document.getElementById("prompt-input");
        const imageUpload = document.getElementById("image-upload");
        const fileNameSpan = document.getElementById("file-name");
        const solveButton = document.getElementById("solve-button");
        const loadingIndicator = document.getElementById("loading-indicator");
        const errorMessage = document.getElementById("error-message");
        const resultText = document.getElementById("result-text");
        const sourcesContainer = document.getElementById("sources-container");
        const sourcesList = document.getElementById("sources-list");

        // ƒê√£ ch√®n API Key c·ªßa b·∫°n
        const apiKey = "AIzaSyCSmpkUhm4TrsdrrIVVbJW7iH4jW9Sc6LI";
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let base64Image = null;

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn t·ªáp ·∫£nh
        imageUpload.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                // Chuy·ªÉn ·∫£nh sang base64
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Ch·ªâ l·∫•y ph·∫ßn base64, b·ªè ph·∫ßn ti·ªÅn t·ªë data:image/...
                    base64Image = reader.result.split(',')[1];
                };
                reader.readAsDataURL(file);
            } else {
                fileNameSpan.textContent = "";
                base64Image = null;
            }
        });

        // X·ª≠ l√Ω khi nh·∫•n n√∫t "Gi·∫£i b√†i"
        solveButton.addEventListener("click", async () => {
            const userPrompt = promptInput.value;

            if (!userPrompt && !base64Image) {
                showError("Vui l√≤ng nh·∫≠p c√¢u h·ªèi ho·∫∑c t·∫£i ·∫£nh l√™n.");
                return;
            }
            
            if (apiKey === "D√ÅN_API_KEY_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY") {
                showError("L·ªói API: B·∫°n ch∆∞a th√™m API Key. Vui l√≤ng xem h∆∞·ªõng d·∫´n trong t·ªáp 'api_key_instructions.md' ho·∫∑c trong m√£ ngu·ªìn.");
                return;
            }

            clearResult();
            setLoading(true);

            try {
                // Ch·ªâ d·∫´n h·ªá th·ªëng cho AI
                const systemPrompt = `
B·∫°n l√† m·ªôt tr·ª£ l√Ω To√°n h·ªçc chuy√™n nghi·ªáp, c√≥ ki·∫øn th·ª©c s√¢u r·ªông v·ªÅ ƒê·∫°i s·ªë v√† H√¨nh h·ªçc t·ª´ l·ªõp 6 ƒë·∫øn l·ªõp 12.
Nhi·ªám v·ª• c·ªßa b·∫°n l√† gi·∫£i c√°c b√†i to√°n m·ªôt c√°ch chi ti·∫øt, t·ª´ng b∆∞·ªõc m·ªôt, d·ªÖ hi·ªÉu.

QUAN TR·ªåNG: Sau khi gi·∫£i xong b√†i to√°n, b·∫°n B·∫ÆT BU·ªòC ph·∫£i th√™m m·ªôt ph·∫ßn t·ªïng k·∫øt c√≥ c·∫•u tr√∫c nh∆∞ sau:

---

### üìù T·ªïng k·∫øt quan tr·ªçng

**1. C√¥ng th·ª©c ƒë√£ s·ª≠ d·ª•ng:**
* (Li·ªát k√™ c√°c c√¥ng th·ª©c to√°n h·ªçc ch√≠nh ƒë√£ d√πng ƒë·ªÉ gi·∫£i b√†i)

**2. M·∫πo gi·∫£i to√°n:**
* (Chia s·∫ª c√°c m·∫πo, chi·∫øn l∆∞·ª£c, ho·∫∑c c√°ch suy nghƒ© ƒë·ªÉ gi·∫£i quy·∫øt d·∫°ng to√°n n√†y nhanh h∆°n ho·∫∑c hi·ªáu qu·∫£ h∆°n)

**3. L·ªói th∆∞·ªùng g·∫∑p v√† c√°ch tr√°nh:**
* (Ch·ªâ ra nh·ªØng sai l·∫ßm ph·ªï bi·∫øn m√† h·ªçc sinh hay m·∫Øc ph·∫£i khi l√†m d·∫°ng b√†i n√†y v√† c√°ch ƒë·ªÉ tr√°nh ch√∫ng)

H√£y s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown (ƒë·∫∑c bi·ªát l√† c√∫ ph√°p LaTeX cho c√¥ng th·ª©c to√°n, v√≠ d·ª•: $$\\frac{a}{b}$$) ƒë·ªÉ tr√¨nh b√†y c√¢u tr·∫£ l·ªùi m·ªôt c√°ch r√µ r√†ng v√† chuy√™n nghi·ªáp.
`;

                // X√¢y d·ª±ng payload (n·ªôi dung g·ª≠i ƒëi)
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: []
                        }
                    ],
                    // Th√™m ch·ªâ d·∫´n h·ªá th·ªëng
                    systemInstruction: {
                        parts: [ { text: systemPrompt } ]
                    },
                    // K√≠ch ho·∫°t Google Search ƒë·ªÉ t√¨m th√¥ng tin (n·∫øu c·∫ßn)
                    tools: [ { "google_search": {} } ]
                };

                // Th√™m c√¢u h·ªèi vƒÉn b·∫£n (n·∫øu c√≥)
                if (userPrompt) {
                    payload.contents[0].parts.push({ text: userPrompt });
                }

                // Th√™m ·∫£nh (n·∫øu c√≥)
                if (base64Image) {
                    payload.contents[0].parts.push({
                        inlineData: {
                            mimeType: "image/jpeg", // Gi·∫£ ƒë·ªãnh l√† jpeg, c√≥ th·ªÉ l√† png
                            data: base64Image
                        }
                    });
                }

                // G·ªçi API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`L·ªói API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Xilogism (B·∫Øt l·ªói an to√†n c·ªßa Google)
                if (!result.candidates || result.candidates.length === 0 || 
                    !result.candidates[0].content || !result.candidates[0].content.parts) {
                    
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        showError(`C√¢u h·ªèi c·ªßa b·∫°n ƒë√£ b·ªã ch·∫∑n v√¨ l√Ω do: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi n·ªôi dung kh√°c.`);
                    } else {
                        showError("AI kh√¥ng th·ªÉ x·ª≠ l√Ω c√¢u h·ªèi n√†y. Vui l√≤ng th·ª≠ l·∫°i.");
                    }
                    return;
                }

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                const generatedText = result.candidates[0].content.parts[0].text;
                showResult(generatedText);

                // Hi·ªÉn th·ªã ngu·ªìn
                const groundingMetadata = result.candidates[0].groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    showSources(groundingMetadata.groundingAttributions);
                }

            } catch (error) {
                console.error(error);
                showError("ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i. L·ªói: " + error.message);
            } finally {
                setLoading(false);
                // ƒê·∫∑t l·∫°i ·∫£nh sau m·ªói l·∫ßn g·ª≠i
                base64Image = null; 
                imageUpload.value = null; // X√≥a t·ªáp ƒë√£ ch·ªçn kh·ªèi input
                fileNameSpan.textContent = "";
            }
        });

        // ----- C√ÅC H√ÄM H·ªñ TR·ª¢ -----

        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove("hidden");
                solveButton.disabled = true;
                solveButton.classList.add("opacity-50", "cursor-not-allowed");
            } else {
                loadingIndicator.classList.add("hidden");
                solveButton.disabled = false;
                solveButton.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove("hidden");
        }

        function clearResult() {
            errorMessage.classList.add("hidden");
            resultText.innerHTML = "";
            sourcesContainer.classList.add("hidden");
            sourcesList.innerHTML = "";
        }

        function showResult(text) {
            // Chuy·ªÉn ƒë·ªïi Markdown sang HTML tr∆∞·ªõc khi hi·ªÉn th·ªã
            resultText.innerHTML = formatTextToHtml(text);
            
            // Y√™u c·∫ßu KaTeX render c√°c c√¥ng th·ª©c to√°n trong k·∫øt qu·∫£
            // D√πng try-catch ƒë·ªÉ tr√°nh l·ªói n·∫øu auto-render kh√¥ng t·ªìn t·∫°i
            try {
                if (window.renderMathInElement) {
                    renderMathInElement(resultText, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false },
                            { left: '\\[', right: '\\]', display: true },
                            { left: '\\(', right: '\\)', display: false }
                        ],
                        throwOnError: false
                    });
                }
            } catch (e) {
                console.error("L·ªói khi render KaTeX:", e);
                showError("ƒê√£ x·∫£y ra l·ªói khi hi·ªÉn th·ªã c√¥ng th·ª©c to√°n. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn.");
            }
        }

        function showSources(sources) {
            sourcesContainer.classList.remove("hidden");
            sourcesList.innerHTML = ""; // X√≥a ngu·ªìn c≈©
            
            const validSources = sources
                .map(attr => attr.web)
                .filter(web => web && web.uri && web.title); // L·ªçc c√°c ngu·ªìn h·ª£p l·ªá

            if (validSources.length > 0) {
                validSources.forEach(source => {
                    const li = document.createElement("li");
                    const a = document.createElement("a");
                    a.href = source.uri;
                    a.textContent = source.title;
                    a.target = "_blank"; // M·ªü trong tab m·ªõi
                    a.rel = "noopener noreferrer";
                    a.className = "hover:underline";
                    li.appendChild(a);
                    sourcesList.appendChild(li);
                });
            } else {
                sourcesContainer.classList.add("hidden");
            }
        }
        
        // H√†m chuy·ªÉn ƒë·ªïi Markdown c∆° b·∫£n sang HTML (an to√†n)
        function formatTextToHtml(text) {
            // 1. Chuy·ªÉn ƒë·ªïi c√°c th·∫ª <br> (n·∫øu AI tr·∫£ v·ªÅ) th√†nh k√Ω t·ª± xu·ªëng d√≤ng
            text = text.replace(/<br\s*\/?>/g, '\n');

            // 2. Chuy·ªÉn ƒë·ªïi ti√™u ƒë·ªÅ (H1-H4) v√† th√™m icon
            const iconBookmark = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="#60A5FA" d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3l7 3V5c0-1.1-.9-2-2-2"/></svg>';
            const iconDoubleAngle = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="#60A5FA" d="m13 16.29l-3.3-3.29l-1.4 1.42l4.7 4.7l4.7-4.7l-1.4-1.42l-3.3 3.3m-4.6-6.6L7 11.1l-1.4-1.42l4.7-4.7l4.7 4.7l-1.4 1.42l-3.3-3.3"/></svg>';
            const iconAngle = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="#60A5FA" d="m10 16.29l-3.3-3.3l-1.4 1.41l4.7 4.7l4.7-4.7l-1.4-1.41l-3.3 3.3"/></svg>';
            const iconCheck = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="#60A5FA" d="M21 7L9 19l-5.5-5.5l1.41-1.41L9 16.17L19.59 5.59z"/></svg>';
            
            text = text.replace(/^(####)\s*(.*)/gm, `<h4>${iconCheck}$2</h4>`);
            text = text.replace(/^(###)\s*(.*)/gm, `<h3>${iconAngle}$2</h3>`);
            text = text.replace(/^(##)\s*(.*)/gm, `<h2>${iconDoubleAngle}$2</h2>`);
            text = text.replace(/^(#)\s*(.*)/gm, `<h1>${iconBookmark}$2</h1>`);

            // 3. X·ª≠ l√Ω B·∫£ng (Table)
            text = text.replace(/\|(.+)\|(.+)\|/g, '<table><thead><tr><th>$1</th><th>$2</th></tr></thead><tbody>')
                       .replace(/\|:---:\|:---:\|/g, '') // B·ªè d√≤ng ph√¢n c√°ch
                       .replace(/\|(.+)\|(.+)\|/g, '<tr><td>$1</td><td>$2</td></tr>')
                       .replace(/(<\/tr>)(?!<\/tbody>)/g, '</tr></tbody>') // ƒê√≥ng tbody kh√¥ng ƒë√∫ng
                       .replace(/<\/tbody>$/g, '</tbody></table>'); // ƒê√≥ng b·∫£ng

            // 3b. S·ª≠a l·ªói in ƒë·∫≠m ($M1) b√™n trong b·∫£ng
            text = text.replace(/<td>(.*?)<\/td>/g, (match, tableCell) => {
                // S·ª≠a l·ªói: $M1 -> $1
                const formattedCell = tableCell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                               .replace(/_(.*?)_/g, '<em>$1</em>');
                return `<td>${formattedCell}</td>`;
            });
            text = text.replace(/<th>(.*?)<\/th>/g, (match, tableCell) => {
                // S·ª≠a l·ªói: $M1 -> $1
                const formattedCell = tableCell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                               .replace(/_(.*?)_/g, '<em>$1</em>');
                return `<th>${formattedCell}</th>`;
            });

            // 4. In ƒë·∫≠m v√† In nghi√™ng (b√™n ngo√†i b·∫£ng)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // 5. X·ª≠ l√Ω danh s√°ch (List)
            // S·ª≠a l·ªói c·ªù regex: 'cm' -> 'gm'
            text = '\n' + text + '\n'; // ƒê·∫£m b·∫£o x·ª≠ l√Ω ƒë√∫ng ·ªü ƒë·∫ßu/cu·ªëi
            text = text.replace(/(\n-\s)(.*)/g, '\n<ul><li>$2</li></ul>');
            text = text.replace(/<\/ul>\n<ul>/g, ''); // G·ªôp c√°c list li·ªÅn k·ªÅ
            
            text = text.replace(/(\n\d+\.\s)(.*)/g, '\n<ol><li>$2</li></ol>');
            text = text.replace(/<\/ol>\n<ol>/g, ''); // G·ªôp c√°c list li·ªÅn k·ªÅ
            
            // 6. Chuy·ªÉn ƒë·ªïi c√°c k√Ω t·ª± xu·ªëng d√≤ng (new paragraphs)
            text = text.replace(/\n\n/g, '<p></p>'); // C√°c ƒëo·∫°n tr·ªëng
            text = text.replace(/\n/g, '<br>'); // C√°c ng·∫Øt d√≤ng ƒë∆°n
            text = text.replace(/<br><(h[1-4]|ul|ol|table)/g, '<$1'); // X√≥a <br> th·ª´a tr∆∞·ªõc ti√™u ƒë·ªÅ/list/b·∫£ng
            text = text.replace(/<br><li>/g, '<li>'); // X√≥a <br> th·ª´a tr∆∞·ªõc <li>
            text = text.replace(/<br><tr>/g, '<tr>'); // X√≥a <br> th·ª´a tr∆∞·ªõc <tr>
            text = text.replace(/(<\/h[1-4]>|<\/ul>|<\/ol>|<\/table>)<br>/g, '$1'); // X√≥a <br> th·ª´a sau ti√™u ƒë·ªÅ/list/b·∫£ng
            
            // 7. D·ªçn d·∫πp
            text = text.replace(/^(<br>)+|(<br>)+$/g, ''); // X√≥a <br> ·ªü ƒë·∫ßu/cu·ªëi

            return text;
        }

    </script>
</body>
</html>
