<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Toán học</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ĐÃ SỬA LỖI 1: Sửa 'xintegrity' thành 'integrity' và thêm 'defer' -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-KiWOvVjnN8qwKMPSsJxsVRKGlQPoB8JOEXMHWCGcquG8rMbtNIsmoxkC+MflxRxA" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-hIoBPJpTUs74ddlX/dyPbe2PYsC7Gc/5N+J4BY+7RVCjSQGqcjSRTMGZlCrWJaLv" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6Xg/TrSiyAUBBYj8rO2czGexiQDCbLGSbTD+N8PAGWEiGjSVOZMr8/Dvx" crossorigin="anonymous"></script>

    <style>
        /* Tùy chỉnh font chữ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Nền xám nhạt */
        }
        
        /* Cải thiện CSS cho các thành phần */
        #result-container h1, #result-container h2, #result-container h3, #result-container h4 {
            font-weight: 600;
            margin-top: 1.25rem; /* Tăng khoảng cách thoáng */
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        #result-container h1 { font-size: 1.5rem; }
        #result-container h2 { font-size: 1.25rem; }
        #result-container h3 { font-size: 1.125rem; }
        #result-container h4 { font-size: 1rem; }

        #result-container p {
            line-height: 1.65;
            margin-bottom: 1rem; /* Tăng khoảng cách đoạn */
        }

        #result-container ul, #result-container ol {
            list-style-position: inside;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        #result-container ul { list-style-type: disc; }
        #result-container ol { list-style-type: decimal; }
        
        #result-container li {
            margin-bottom: 0.5rem;
        }

        #result-container a {
            color: #2563eb;
            text-decoration: underline;
        }

        /* Định dạng Bảng (Table) chuyên nghiệp */
        #result-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden; /* Để bo góc */
        }

        #result-container th, #result-container td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            text-align: left;
            line-height: 1.5;
        }

        #result-container th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        #result-container td {
            background-color: #ffffff;
        }
        
        /* CSS cho thư viện KaTeX */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
        }
    </style>
</head>

<body class="h-full flex items-center justify-center p-4 md:p-8">
    <div class="w-full max-w-3xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10">
        
        <!-- Tiêu đề chính -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 flex items-center justify-center">
                Trợ lý Toán học
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ml-3 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h.008v.008H12V7zM3 9v6a3 3 0 003 3h12a3 3 0 003-3V9m-18 0l-1-1v-1a3 3 0 013-3h12a3 3 0 013 3v1l-1 1M3 9h18" />
                </svg>
            </h1>
            <p class="text-gray-500 mt-2">Giải bài tập Đại số & Hình học (lớp 6-12), kèm theo mẹo và tổng kết công thức.</p>
        </div>

        <!-- Đường kẻ phân cách -->
        <hr class="my-6 border-gray-200">

        <!-- Khu vực nhập câu hỏi -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                Nhập đề bài của bạn
            </h2>

            <!-- Ô nhập văn bản -->
            <textarea id="prompt-input"
                class="w-full h-40 p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow resize-y"
            ></textarea>

            <!-- Nút tải ảnh -->
            <div class="mt-4 flex items-center">
                <label for="image-upload" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg inline-flex items-center transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Tải ảnh đề bài (nếu có)
                </label>
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                <span id="file-name" class="ml-4 text-gray-500 text-sm italic"></span>
            </div>

            <!-- Nút Giải bài -->
            <button id="solve-button"
                class="w-full mt-5 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Giải bài
            </button>
        </div>

        <!-- Khu vực bài giải -->
        <div id="result-section" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.747 0-3.332.477-4.5 1.253" />
                </svg>
                Bài giải:
            </h2>
            <div id="loading-spinner" class="hidden text-center py-10">
                <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-blue-500 border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                    role="status">
                    <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Đang tải...</span>
                </div>
                <p class="mt-4 text-gray-500">AI đang suy nghĩ, vui lòng chờ...</p>
            </div>
            <div id="result-container" class="prose max-w-none">
                <!-- Câu trả lời sẽ xuất hiện ở đây -->
            </div>
        </div>

        <!-- Khu vực Nguồn tham khảo (nếu có) -->
        <div id="sources-section" class="mt-6 pt-4 border-t border-gray-200 hidden">
             <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101" />
                </svg>
                Nguồn tham khảo:
            </h3>
            <ul id="sources-list" class="list-disc pl-6 text-sm">
                <!-- Nguồn sẽ xuất hiện ở đây -->
            </ul>
        </div>

    </div>

    <script type="module">
        // Khởi tạo các biến
        const promptInput = document.getElementById('prompt-input');
        const solveButton = document.getElementById('solve-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultContainer = document.getElementById('result-container');
        const imageUpload = document.getElementById('image-upload');
        const fileNameSpan = document.getElementById('file-name');
        
        const sourcesSection = document.getElementById('sources-section');
        const sourcesList = document.getElementById('sources-list');

        let imageBase64 = null;
        let imageMimeType = null;

        // Xử lý tải ảnh lên
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                imageBase64 = null;
                imageMimeType = null;
                fileNameSpan.textContent = '';
                return;
            }

            // Giới hạn loại tệp
            if (!file.type.startsWith('image/')) {
                alert('Chỉ hỗ trợ tệp hình ảnh (PNG, JPG, v.v.)');
                return;
            }
            
            fileNameSpan.textContent = file.name;

            // Chuyển ảnh sang Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const base64String = reader.result.split(',')[1]; // Chỉ lấy phần base64
                imageBase64 = base64String;
                imageMimeType = file.type;
            };
            reader.onerror = (error) => {
                console.error('Lỗi đọc tệp:', error);
                fileNameSpan.textContent = 'Lỗi tải ảnh.';
            };
        });

        // Xử lý nhấn nút Giải bài
        solveButton.addEventListener('click', async () => {
            const userQuery = promptInput.value.trim();

            if (!userQuery && !imageBase64) {
                resultContainer.textContent = 'Vui lòng nhập câu hỏi hoặc tải ảnh lên.';
                return;
            }

            // Hiển thị loading và vô hiệu hóa nút
            loadingSpinner.classList.remove('hidden');
            resultContainer.innerHTML = '';
            sourcesSection.classList.add('hidden');
            sourcesList.innerHTML = '';
            solveButton.disabled = true;

            try {
                // Chỉ dẫn hệ thống (System Prompt)
                const systemPrompt = `Bạn là một trợ lý Toán học chuyên nghiệp, đặc biệt giỏi giải toán Đại số và Hình học cho học sinh Việt Nam từ lớp 6 đến lớp 12.
Nhiệm vụ của bạn là:
1.  Nhận đề bài (dưới dạng văn bản hoặc hình ảnh) và cung cấp lời giải CHI TIẾT, TỪNG BƯỚC một.
2.  Sau khi giải xong, bạn **BẮT BUỘC** phải cung cấp một phần tổng kết ở cuối bài, có cấu trúc rõ ràng với các tiêu đề Markdown (ví dụ: '### Tổng kết'):
    * **Công thức đã sử dụng:** Liệt kê các công thức toán học chính đã dùng trong bài giải.
    * **Mẹo giải toán:** Chỉ ra các phương pháp, mẹo, hoặc kỹ thuật đặc biệt để giải nhanh hoặc dễ hiểu hơn.
    * **Lỗi thường gặp & Cách tránh:** Nêu rõ những lỗi sai phổ biến mà học sinh hay mắc phải khi làm dạng bài này và cách để tránh chúng.
3.  Sử dụng cú pháp KaTeX (ví dụ: $$\\frac{a}{b}$$ hoặc $$\\Delta = b^2 - 4ac$$) cho tất cả các công thức toán học.
4.  Sử dụng Google Search (nếu cần) để tìm kiếm thông tin, công thức, hoặc các dạng bài toán tương tự để đưa ra câu trả lời chính xác nhất.
5.  Trình bày câu trả lời một cách chuyên nghiệp, rõ ràng, thoáng đãng, sử dụng Markdown (tiêu đề, danh sách) để phân cấp nội dung.`;

                // Xây dựng payload
                const payload = {
                    contents: [{
                        parts: [
                            // { text: userQuery } // Chúng ta sẽ thêm phần này bên dưới
                        ]
                    }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                // Thêm văn bản nếu có
                if (userQuery) {
                    payload.contents[0].parts.push({ text: userQuery });
                }

                // Thêm ảnh nếu có
                if (imageBase64 && imageMimeType) {
                    payload.contents[0].parts.push({
                        inlineData: {
                            mimeType: imageMimeType,
                            data: imageBase64
                        }
                    });
                }
                
                // GỌI API GEMINI - ĐÂY LÀ PHẦN BẠN CẦN THAY THẾ KEY
                // const apiKey = ""; // Dòng này sẽ không hoạt động trên GitHub
                // HÃY THAY THẾ BẰNG API KEY CỦA BẠN NHƯ HƯỚNG DẪN
                const apiKey = "AIzaSyCSmpkUhm4TrsdrrIVVbJW7iH4jW9Sc6LI"; // <<<<< THAY THẾ DÒNG NÀY
                
                if (apiKey === "DÁN_API_KEY_CỦA_BẠN_VÀO_ĐÂY") {
                   throw new Error("Bạn chưa thêm API Key. Vui lòng làm theo tệp 'api_key_instructions.md'.");
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                let text = '';
                let sources = [];
                let retries = 3;
                let delay = 1000;

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // Nếu lỗi 400, thường là do API key sai
                            if (response.status === 400) {
                                throw new Error(`Lỗi API: ${response.statusText} (Rất có thể API Key của bạn bị sai hoặc chưa được kích hoạt).`);
                            }
                            throw new Error(`Lỗi API: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            text = candidate.content.parts[0].text;
                            
                            // Xử lý nguồn tham khảo
                            const groundingMetadata = candidate.groundingMetadata;
                            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title);
                            }
                            break; // Thoát khỏi vòng lặp nếu thành công
                        } else {
                            // Đôi khi AI trả về nội dung trống nếu bị chặn
                            if (candidate && candidate.finishReason === 'SAFETY') {
                                throw new Error('AI đã từ chối trả lời vì lý do an toàn/bản quyền.');
                            }
                            throw new Error('Không nhận được nội dung hợp lệ từ AI.');
                        }
                    } catch (error) {
                        console.error(`Lỗi lần thử ${i + 1}:`, error);
                        if (i === retries - 1) {
                            throw error; // Ném lỗi cuối cùng nếu hết số lần thử
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Tăng gấp đôi thời gian chờ
                    }
                }

                // Định dạng và hiển thị kết quả
                const formattedHtml = formatTextToHtml(text);
                resultContainer.innerHTML = formattedHtml;
                
                // Render KaTeX
                renderMathInElement(resultContainer, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false },
                        { left: '\\(', right: '\\)', display: false },
                        { left: '\\[', right: '\\]', display: true }
                    ],
                    throwOnError: false
                });

                // Hiển thị nguồn
                if (sources.length > 0) {
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title}</a>`;
                        sourcesList.appendChild(li);
                    });
                    sourcesSection.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Lỗi nghiêm trọng khi giải bài:', error);
                resultContainer.innerHTML = `<p class="text-red-600 font-medium">Đã xảy ra lỗi. Vui lòng thử lại. Lỗi: ${error.message}</p>`;
            } finally {
                // Ẩn loading và kích hoạt lại nút
                loadingSpinner.classList.add('hidden');
                solveButton.disabled = false;
            }
        });

        // Hàm định dạng văn bản (Markdown sang HTML)
        function formatTextToHtml(text) {
            // Sửa lỗi <br> và xử lý xuống dòng
            let html = text
                .replace(/<br\s*\/?>/gi, '\n') // Chuyển <br> thành xuống dòng
                .replace(/\n{3,}/g, '\n\n'); // Giới hạn tối đa 2 lần xuống dòng

            // Xử lý Bảng (Table)
            const tableRegex = /^\|(.*?)\|\s*\n\|\s*:(?:---)+:?(?:.*?)\|\s*\n((?:\|.*?\n?)*)/gm;
            html = html.replace(tableRegex, (match, headerRow, bodyRows) => {
                let tableHtml = '<table><thead><tr>';
                
                // Tiêu đề
                const headers = headerRow.split('|').map(h => h.trim()).filter(Boolean);
                headers.forEach(header => {
                    tableHtml += `<th>${header}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                // Nội dung
                const rows = bodyRows.split('\n').filter(Boolean);
                rows.forEach(row => {
                    tableHtml += '<tr>';
                    const cells = row.split('|').map(c => c.trim()).filter(Boolean);
                    cells.forEach(cell => {
                        // ĐÃ SỬA LỖI 2: Sửa '$M1' thành '$1'
                        let cellContent = cell
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<i>$1</i>');
                        tableHtml += `<td>${cellContent}</td>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                return tableHtml;
            });
            
            // Xử lý Tiêu đề (Headings) với Icons
            html = html
                .replace(/^#### (.*$)/gim, '<h4><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>$1</h4>')
                .replace(/^### (.*$)/gim, '<h3><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline-block text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 inline-block text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 inline-block text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>$1</h1>');

            // Xử lý In đậm và In nghiêng
            html = html
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>');

            // Xử lý Danh sách (List) - đảm bảo chúng được bọc trong <ul> hoặc <ol>
            // Biến đổi các dòng * thành <ul>
            html = html.replace(/^(?<!<li.*?>)\s*\*\s(.*?)$/gm, '<ul>\n  <li>$1</li>\n</ul>');
            // Biến đổi các dòng 1. 2. 3. thành <ol>
            html = html.replace(/^(?<!<li.*?>)\s*\d+\.\s(.*?)$/gm, '<ol>\n  <li>$1</li>\n</ol>');
            
            // Gộp các danh sách liền kề
            html = html.replace(/<\/ul>\n<ul>/g, '');
            html = html.replace(/<\/ol>\n<ol>/g, '');
            
            // Biến đổi các mục danh sách tiếp theo
            html = html.replace(/^(?!<(ul|ol)>.*?>)\s*\*\s(.*?)$/gm, '  <li>$1</li>');
            // ĐÃ SỬA LỖI 3: Sửa 'cm' thành 'gm' (lỗi Invalid regular expression flags)
            html = html.replace(/^(?!<(ul|ol)>.*?>)\s*\d+\.\s(.*?)$/gm, '  <li>$1</li>');

            // Xử lý xuống dòng (chuyển đổi \n thành <p>)
            html = html.split('\n\n').map(paragraph => {
                // Chỉ bọc thẻ <p> nếu nó không phải là thẻ HTML đã được xử lý (như <table>, <ul>, <h1>...)
                if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
                    return paragraph;
                }
                return paragraph.trim() ? `<p>${paragraph.replace(/\n/g, '<br>')}</p>` : '';
            }).join('');
            
            // Dọn dẹp thẻ <p> rỗng bọc quanh các thẻ block
            html = html.replace(/<p>\s*(<(h[1-4]|ul|ol|table))/g, '$1');
            html = html.replace(/((h[1-4]|ul|ol|table)>)\s*<\/p>/g, '$1');

            return html;
        }

    </script>
</body>

</html>

